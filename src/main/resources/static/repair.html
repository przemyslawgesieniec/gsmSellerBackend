<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Serwis - Naprawy</title>

  <!-- Materialize CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Nasze style -->
  <link href="css/style.css" rel="stylesheet">
  <style>
    .kanban-board {
      display: flex;
      gap: 15px;
      padding: 10px;
      overflow-x: auto;
      min-height: calc(100vh - 150px);
    }
    .kanban-column {
      flex: 1;
      min-width: 300px;
      background-color: #f5f5f5;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 170px);
    }
    .kanban-column-header {
      padding: 15px;
      font-weight: bold;
      font-size: 1.2rem;
      border-bottom: 2px solid #ddd;
      background-color: #eee;
      border-radius: 8px 8px 0 0;
      text-align: center;
    }
    .kanban-cards {
      padding: 10px;
      flex-grow: 1;
      overflow-y: auto;
    }
    .kanban-card {
      margin-bottom: 10px;
      cursor: grab;
      user-select: none;
    }
    .kanban-card:active {
      cursor: grabbing;
    }
    .kanban-card .card-content {
      padding: 12px !important;
    }
    .kanban-card .card-title {
      font-size: 1.1rem !important;
      font-weight: 500;
      margin-bottom: 5px !important;
    }
    .kanban-card p {
      margin: 2px 0;
      font-size: 0.9rem;
    }
    .drag-over {
      background-color: #e0e0e0;
      border: 2px dashed #999;
    }
    
    .kanban-card.overdue {
      background-color: #fffde7 !important; /* light yellow */
      border: 2px solid #fbc02d;
    }
    .overdue-icon {
      position: absolute;
      top: 5px;
      right: 5px;
      color: #f57f17;
      font-size: 24px;
    }
    
    .kanban-card.status-NAPRAWIONY {
      background-color: #e8f5e9 !important; /* light green */
    }
    .kanban-card.status-ANULOWANY {
      background-color: #f5f5f5 !important; /* light gray */
    }
    .kanban-card.status-NIE_DO_NAPRAWY {
      background-color: #ffeae6 !important; /* light red/peach */
    }

    @keyframes shake {
      0% { transform: translate(1px, 1px) rotate(0deg); }
      10% { transform: translate(-1px, -2px) rotate(-1deg); }
      20% { transform: translate(-3px, 0px) rotate(1deg); }
      30% { transform: translate(3px, 2px) rotate(0deg); }
      40% { transform: translate(1px, -1px) rotate(1deg); }
      50% { transform: translate(-1px, 2px) rotate(-1deg); }
      60% { transform: translate(-3px, 1px) rotate(0deg); }
      70% { transform: translate(3px, 1px) rotate(-1deg); }
      80% { transform: translate(-1px, -1px) rotate(1deg); }
      90% { transform: translate(1px, 2px) rotate(0deg); }
      100% { transform: translate(1px, -2px) rotate(-1deg); }
    }

    @keyframes fadeOutBorder {
      0% { border: 3px solid #ff9800; }
      100% { border: 1px solid transparent; }
    }

    .highlight-card {
      animation: shake 0.5s, blink 0.5s 3, fadeOutBorder 2s forwards;
      z-index: 10;
    }
    
    /* Mobile view with tabs */
    @media only screen and (max-width: 992px) {
      .kanban-board {
        display: none;
      }
      .mobile-repair-view {
        display: block;
      }
    }
    @media only screen and (min-width: 993px) {
      .mobile-repair-view {
        display: none;
      }
    }

    .fab-fixed {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 100;
    }
    .section-title {
      font-size: 1.2rem;
      font-weight: bold;
      margin-top: 20px;
      margin-bottom: 10px;
      border-bottom: 1px solid #2196f3;
      padding-bottom: 5px;
    }
  </style>
</head>
<body>

<!-- Navbar -->
<div id="navbar"></div>
<script src="js/loadNavbar.js"></script>

<div class="container wide-layout">
  <h4 class="center-align">Zlecenia Serwisowe</h4>

  <!-- Desktop Kanban Board -->
  <div class="row" style="margin-top: 20px;">
    <div class="col s12 m4 l3">
      <div class="input-field" id="filterLocationWrapper">
        <select id="filterLocationSelect">
          <option value="">Wszystkie lokalizacje</option>
        </select>
        <label>Filtruj wg lokalizacji</label>
      </div>
    </div>
  </div>

  <div class="kanban-board">
    <div class="kanban-column" id="col-DO_NAPRAWY" ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
      <div class="kanban-column-header blue-text text-darken-2">DO NAPRAWY</div>
      <div class="kanban-cards" id="cards-DO_NAPRAWY"></div>
    </div>
    <div class="kanban-column" id="col-W_NAPRAWIE" ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
      <div class="kanban-column-header orange-text text-darken-2">W NAPRAWIE</div>
      <div class="kanban-cards" id="cards-W_NAPRAWIE"></div>
    </div>
    <div class="kanban-column" id="col-ZAKONCZONY" ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
      <div class="kanban-column-header green-text text-darken-2">ZAKOŃCZONY</div>
      <div class="kanban-cards" id="cards-ZAKONCZONY"></div>
    </div>
  </div>

  <!-- Mobile Tabs View -->
  <div class="mobile-repair-view">
    <div class="row">
      <div class="col s12">
        <ul class="tabs">
          <li class="tab col s4"><a href="#tab-DO_NAPRAWY" class="blue-text">Do naprawy</a></li>
          <li class="tab col s4"><a href="#tab-W_NAPRAWIE" class="orange-text">W naprawie</a></li>
          <li class="tab col s4"><a href="#tab-ZAKONCZONY" class="green-text">Zakończony</a></li>
        </ul>
      </div>
      <div id="tab-DO_NAPRAWY" class="col s12">
        <div id="mobile-cards-DO_NAPRAWY" class="row" style="margin-top: 10px;"></div>
      </div>
      <div id="tab-W_NAPRAWIE" class="col s12">
        <div id="mobile-cards-W_NAPRAWIE" class="row" style="margin-top: 10px;"></div>
      </div>
      <div id="tab-ZAKONCZONY" class="col s12">
        <div id="mobile-cards-ZAKONCZONY" class="row" style="margin-top: 10px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Floating Action Button -->
<div class="fab-fixed">
  <a class="btn-floating btn-large waves-effect waves-light red">
    <i class="material-icons">add</i>
  </a>
</div>

<!-- Modal: Dodawanie/Edycja naprawy -->
<div id="repairModal" class="modal modal-fixed-footer" style="width: 85% !important; max-height: 90% !important;">
  <div class="modal-content">
    <h5 id="modalTitle">Szczegóły naprawy</h5>
    <form id="repairForm">
      <input type="hidden" id="repairTechnicalId">
      <input type="hidden" id="isForCustomer" value="true">
      <input type="hidden" id="phoneTechnicalId">

      <div id="rmaDisplay" style="display: none;">
          <div class="row" style="margin-bottom: 0;">
              <div class="input-field col s12">
                  <input type="text" id="repairRma" readonly>
                  <label for="repairRma" class="active">Numer RMA</label>
              </div>
          </div>
      </div>

      <!-- Sekcja 1: Klient -->
      <div id="repairClientSectionWrapper">
        <div class="section-title blue-text text-darken-2">Sekcja 1 - Klient</div>
        <div class="row card-panel grey lighten-5" style="box-shadow: none; border: 1px solid #ddd;">
          <div class="col s12">
            <p>
              <label>
                <input type="checkbox" id="clientAnonymous" class="filled-in" />
                <span>Klient anonimowy</span>
              </label>
            </p>
          </div>
          <div id="clientSearchSection">
            <div class="input-field col s12">
              <i class="material-icons prefix">search</i>
              <input type="text" id="clientSearch" class="autocomplete">
              <label for="clientSearch">Wyszukaj klienta (Imię, Nazwisko lub Telefon)</label>
              <input type="hidden" id="selectedClientTechnicalId">
            </div>
            <div class="col s12">
               <p class="grey-text">Wybierz klienta z listy lub <a href="#!" id="btnAddNewClient">dodaj nowego klienta</a></p>
            </div>
          </div>

          <div id="newClientFields" style="display: none;">
            <div id="clientNameSurnameFields">
              <div class="input-field col s12 m4">
                <input id="clientName" type="text">
                <label for="clientName">Imię *</label>
              </div>
              <div class="input-field col s12 m4">
                <input id="clientSurname" type="text">
                <label for="clientSurname">Nazwisko *</label>
              </div>
            </div>
            <div class="input-field col s12 m4">
              <input id="clientPhone" type="text">
              <label for="clientPhone">Numer telefonu *</label>
            </div>
            <div class="col s12">
               <button type="button" class="btn-small grey" id="cancelNewClient">Wróć do wyszukiwania</button>
            </div>
          </div>
          
          <div id="selectedClientInfo" style="display: none;" class="col s12">
              <div class="chip blue white-text" id="selectedClientChip" style="cursor: pointer;">
                  <span id="selectedClientDisplay"></span>
                  <i class="close material-icons" id="clearSelectedClient">close</i>
              </div>
          </div>
        </div>
      </div>
      
      <div id="ownRepairInfo" style="display: none;">
        <div class="section-title blue-text text-darken-2">Sekcja 1 - Klient</div>
        <div class="row card-panel grey lighten-5" style="box-shadow: none; border: 1px solid #ddd;">
           <div class="col s12">
             <h6 class="blue-text text-darken-2"><b>Naprawa własna</b></h6>
             <p>To zlecenie dotyczy naprawy własnego urządzenia na stan sklepowy.</p>
           </div>
        </div>
      </div>

      <!-- Sekcja 2: Urządzenie -->
      <div class="section-title blue-text text-darken-2">Sekcja 2 - Urządzenie</div>
      <div class="row card-panel grey lighten-5" style="box-shadow: none; border: 1px solid #ddd;">
        <div class="input-field col s12 m6">
          <select id="repairDeviceType">
            <option value="TELEFON" selected>Telefon</option>
            <option value="TABLET">Tablet</option>
            <option value="SMARTWATCH">Smartwatch</option>
            <option value="INNE">Inne</option>
          </select>
          <label>Typ urządzenia</label>
        </div>
        <div class="input-field col s12 m6">
          <input id="repairManufacturer" type="text">
          <label for="repairManufacturer">Producent</label>
        </div>
        <div class="input-field col s12 m6">
          <input id="repairModel" type="text" required>
          <label for="repairModel">Model *</label>
        </div>
        <div class="input-field col s12 m6">
          <input id="repairImei" type="text">
          <label for="repairImei">IMEI</label>
        </div>
        <div class="input-field col s12 m6" id="repairLocationSection" style="display: none;">
          <select id="repairLocation">
            <option value="" disabled selected>Wybierz lokalizację</option>
          </select>
          <label>Lokalizacja (tylko Admin)</label>
        </div>
      </div>

      <!-- Sekcja 3: Naprawa -->
      <div class="section-title blue-text text-darken-2">Sekcja 3 - Naprawa</div>
      <div class="row card-panel grey lighten-5" style="box-shadow: none; border: 1px solid #ddd;">
        <div class="input-field col s12 m6">
          <textarea id="repairProblemDescription" class="materialize-textarea"></textarea>
          <label for="repairProblemDescription">Opis problemu</label>
        </div>
        <div class="input-field col s12 m6">
          <textarea id="repairDeviceCondition" class="materialize-textarea"></textarea>
          <label for="repairDeviceCondition">Stan telefonu</label>
        </div>
        <div class="input-field col s12 m12">
          <textarea id="repairRemarks" class="materialize-textarea"></textarea>
          <label for="repairRemarks">Uwagi</label>
        </div>

        <div class="input-field col s12 m6">
           <input id="repairLockCode" type="text">
           <label for="repairLockCode">Kod blokady telefonu</label>
        </div>

        <div class="col s12 m6">
            <div class="file-field input-field">
              <div class="btn-small blue">
                <span>Zdjęcia</span>
                <input type="file" multiple id="repairPhotos">
              </div>
              <div class="file-path-wrapper">
                <input class="file-path validate" type="text" placeholder="Dodaj zdjęcia urządzenia">
              </div>
            </div>
        </div>

        <div class="col s12 m4">
          <p>
            <label>
              <input type="checkbox" id="repairMoistureTraces" class="filled-in" />
              <span>Ślady zawilgocenia</span>
            </label>
          </p>
        </div>
        <div class="col s12 m4">
          <p>
            <label>
              <input type="checkbox" id="repairWarrantyRepair" class="filled-in" />
              <span>Naprawa gwarancyjna</span>
            </label>
          </p>
        </div>
        <div class="col s12 m4">
          <p>
            <label>
              <input type="checkbox" id="repairTurnsOn" class="filled-in" />
              <span>Czy telefon się uruchamia?</span>
            </label>
          </p>
        </div>

        <div class="input-field col s12 m4">
          <input id="repairReceiptDate" type="date">
          <label for="repairReceiptDate" class="active">Data przyjęcia</label>
        </div>
        <div class="input-field col s12 m4">
          <input id="repairEstimatedRepairDate" type="date">
          <label for="repairEstimatedRepairDate" class="active">Szacowana data naprawy</label>
        </div>
        <div class="input-field col s12 m3">
          <input id="repairEstimatedCost" type="number" step="0.01">
          <label for="repairEstimatedCost">Szacowany koszt naprawy</label>
        </div>
        <div class="input-field col s12 m3">
          <input id="repairAdvancePayment" type="number" step="0.01">
          <label for="repairAdvancePayment">Kwota przyjętej zaliczki</label>
        </div>
        
        <div id="repairFinalPriceWrapper" style="display: none;">
            <div class="input-field col s12 m6">
              <input id="repairPrice" type="number" step="0.01">
              <label for="repairPrice">Ostateczna cena naprawy</label>
            </div>
        </div>
        
        <!-- Legacy fields for shop repairs -->
        <div id="shopRepairFields" style="display: none;">
            <div class="input-field col s12 m6">
              <input id="repairPurchasePrice" type="number" step="0.01">
              <label for="repairPurchasePrice">Cena zakupu / przyjęcia</label>
            </div>
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button class="btn-flat modal-close waves-effect waves-red">Anuluj</button>
    <button class="btn orange darken-2 waves-effect waves-light" id="editRepairBtn" style="display: none;">Edytuj</button>
    <button class="btn blue darken-2 waves-effect waves-light" id="saveRepairBtn">Zapisz</button>
  </div>
</div>

<!-- Modal: Przywróć na sklep -->
<div id="restoreToShopModal" class="modal">
  <div class="modal-content">
    <h5>Przywróć telefon na sklep</h5>
    <div class="row">
      <form id="restoreToShopForm">
        <input type="hidden" id="restoreRepairId">
        <div class="input-field col s12 m4">
          <input id="restorePurchasePrice" type="number" step="0.01" readonly>
          <label for="restorePurchasePrice" class="active">Cena zakupu</label>
        </div>
        <div class="input-field col s12 m4">
          <input id="restoreRepairPrice" type="number" step="0.01">
          <label for="restoreRepairPrice">Koszt naprawy</label>
        </div>
        <div class="input-field col s12 m4">
          <input id="restoreSellingPrice" type="number" step="0.01">
          <label for="restoreSellingPrice">Ostateczna cena sprzedaży</label>
        </div>
        <div class="input-field col s12">
          <select id="restoreLocation">
            <option value="" disabled selected>Wybierz lokalizację</option>
          </select>
          <label>Lokalizacja</label>
        </div>
      </form>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn-flat modal-close waves-effect waves-red">Anuluj</button>
    <button class="btn green darken-2 waves-effect waves-light" id="confirmRestoreBtn">Zatwierdź</button>
  </div>
</div>

<!-- Modal: Wybór statusu zakończenia -->
<div id="statusSelectionModal" class="modal">
  <div class="modal-content">
    <h5>Zakończenie naprawy</h5>
    <input type="hidden" id="statusSelectionRepairId">
    
    <div class="row" id="finalStatusSelectionWrapper">
      <div class="input-field col s12">
        <select id="finalStatusSelect">
          <option value="" disabled selected>Wybierz wynik naprawy</option>
          <option value="NAPRAWIONY">Naprawiony</option>
          <option value="NIE_DO_NAPRAWY">Nie do naprawy</option>
          <option value="ANULOWANY">Anulowany</option>
        </select>
        <label>Status końcowy</label>
      </div>
    </div>

    <!-- Sekcja dla Nie do naprawy / Anulowany -->
    <div id="diagnosticCostSection" style="display: none;">
      <div class="row">
        <div class="input-field col s12">
          <input id="diagnosticCost" type="number" step="0.01" value="70">
          <label for="diagnosticCost" class="active">Koszt diagnostyki (zł)</label>
        </div>
      </div>
    </div>

    <!-- Sekcja dla Naprawiony -->
    <div id="repairFinishedSection" style="display: none;">
      <div class="row" id="repairFinishedCustomerFields">
        <div class="input-field col s12 m6">
          <input id="finalAdvancePayment" type="number" step="0.01" readonly>
          <label for="finalAdvancePayment" class="active">Wpłacona zaliczka</label>
        </div>
        <div class="input-field col s12 m6">
          <input id="finalEstimatedCost" type="number" step="0.01" readonly>
          <label for="finalEstimatedCost" class="active">Szacowany koszt naprawy</label>
        </div>
      </div>
      <div class="row">
        <div class="input-field col s12 m6" id="finalRealCostWrapper">
          <input id="finalRealCost" type="number" step="0.01">
          <label for="finalRealCost">Realny koszt naprawy (koszt części itp.)</label>
        </div>
        <div class="input-field col s12 m6" id="finalCustomerPriceWrapper">
          <input id="finalCustomerPrice" type="number" step="0.01">
          <label for="finalCustomerPrice">Cena dla klienta (suma)</label>
        </div>
      </div>
    </div>

  </div>
  <div class="modal-footer">
    <button class="btn-flat waves-effect" onclick="cancelStatusSelection()">Anuluj</button>
    <button class="btn blue darken-2 waves-effect waves-light" id="btnConfirmFinalizeStatus">Zatwierdź</button>
  </div>
</div>

<!-- Modal: Potwierdzenie zmiany statusu -->
<div id="confirmStatusChangeModal" class="modal">
  <div class="modal-content">
    <h5>Potwierdź zmianę statusu</h5>
    <p id="confirmStatusChangeMessage">Czy na pewno chcesz zmienić status tego zlecenia?</p>
  </div>
  <div class="modal-footer">
    <button class="btn-flat modal-close waves-effect waves-red">Anuluj</button>
    <button class="btn blue darken-2 waves-effect waves-light" id="confirmStatusChangeBtn">Zatwierdź</button>
  </div>
</div>

<style>
  .full-width {
    width: 100%;
    margin-bottom: 10px;
  }
</style>


<!-- Materialize JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script src="js/auth.js"></script>
<script src="js/repair.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    M.Tabs.init(document.querySelectorAll('.tabs'));
    M.Modal.init(document.querySelectorAll('.modal'));
  });
</script>

</body>
</html>
